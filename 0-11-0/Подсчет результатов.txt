// –°–∫—Ä–∏–ø—Ç "–ü–æ–¥—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.txt"
(() => {
  'use strict';

  // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ =====
  const resultsKey = 'count_results';
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑ localStorage
  const savedResults = JSON.parse(localStorage.getItem(resultsKey) || '{}');
  let totalCounters = savedResults.totalCounters || 0;
  let loadedCounters = savedResults.loadedCounters || 0;

  // ===== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ–∫—Ü–∏–∏ –≤ –æ–±—â–µ–π –ø–∞–Ω–µ–ª–∏ =====
  // –ñ–¥–µ–º, –ø–æ–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω
  function waitForManager() {
    return new Promise((resolve) => {
      if (window.meterScriptsPanelManager) {
        resolve();
        return;
      }
      const checkInterval = setInterval(() => {
        if (window.meterScriptsPanelManager) {
          clearInterval(checkInterval);
          resolve();
        }
      }, 100);
      // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
      setTimeout(() => {
        clearInterval(checkInterval);
        if (!window.meterScriptsPanelManager) {
          console.error('–ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±—â–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç "–ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±—â–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫.txt" –∑–∞–≥—Ä—É–∂–µ–Ω –ø–µ—Ä–≤—ã–º.');
        }
        resolve();
      }, 5000);
    });
  }

  waitForManager().then(() => {
    if (!window.meterScriptsPanelManager) return;

    const sectionHtml = `
      <div style="margin-bottom:8px;">
        <label style="display:block; margin-bottom:4px;">
          –°—á–µ—Ç—á–∏–∫–æ–≤ –≤—Å–µ–≥–æ: <span id="totalCountersDisplay" style="font-weight:bold;">0</span>
        </label>
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:block; margin-bottom:4px;">
          –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—á–µ—Ç—á–∏–∫–æ–≤: <span id="loadedCountersDisplay" style="font-weight:bold;">0</span>
        </label>
      </div>
      <button id="countAllBtn" style="width:100%; padding:8px; background:#007acc; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:bold;">
        –ü–æ–¥—Å—á–µ—Ç –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤
      </button>
    `;

    window.meterScriptsPanelManager.registerSection('count', '–ü–æ–¥—Å—á–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', sectionHtml, {
      onRender: (container) => {
        const totalCountersDisplay = container.querySelector('#totalCountersDisplay');
        const loadedCountersDisplay = container.querySelector('#loadedCountersDisplay');
        const countAllBtn = container.querySelector('#countAllBtn');

        // ===== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è =====
        function updateDisplay() {
          totalCountersDisplay.textContent = totalCounters;
          loadedCountersDisplay.textContent = loadedCounters;
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ localStorage
          localStorage.setItem(resultsKey, JSON.stringify({
            totalCounters: totalCounters,
            loadedCounters: loadedCounters
          }));
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        updateDisplay();

        // ===== –£—Ç–∏–ª–∏—Ç—ã =====
        const wait = (ms) => new Promise((r) => setTimeout(r, ms));

        function showToast(text, time = 7000, color = '#333') {
          let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      Object.assign(toastContainer.style, {
        position: 'fixed',
        bottom: '20px',
        right: '20px',
        zIndex: '999999',
        display: 'flex',
        flexDirection: 'column',
        gap: '10px',
        pointerEvents: 'none',
        alignItems: 'flex-end'
      });
      document.body.appendChild(toastContainer);
    }

    const toast = document.createElement('div');
    toast.textContent = text;
    Object.assign(toast.style, {
      background: color,
      color: '#fff',
      padding: '10px 20px',
      borderRadius: '10px',
      fontSize: '14px',
      opacity: '0',
      pointerEvents: 'none',
      fontFamily: 'sans-serif',
      transition: 'opacity 0.3s ease, transform 0.3s ease',
      transform: 'translateY(10px)',
      maxWidth: '400px',
      wordWrap: 'break-word',
      whiteSpace: 'normal'
    });

    toastContainer.appendChild(toast);

    setTimeout(() => {
      toast.style.opacity = '0.95';
      toast.style.transform = 'translateY(0)';
    }, 10);

    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.remove();
        }
        if (toastContainer.children.length === 0) {
          toastContainer.remove();
        }
      }, 300);
    }, time);
  }

        async function waitForSelector(selector, timeout = 10000) {
          const start = Date.now();
          while (Date.now() - start < timeout) {
            const el = document.querySelector(selector);
            if (el) return el;
            await wait(100);
          }
          return null;
        }

        // ===== –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ =====
        async function countAllCounters() {
          try {
      // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      if (window.location.href !== 'https://meter.printecs.com/') {
        window.location.href = 'https://meter.printecs.com/';
        await wait(2000); // –ñ–¥–µ–º –Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏
      }

      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤
      showToast('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤...', 3000, '#555');
      const addressesContainer = await waitForSelector('div._tasksContainer_36r29_11', 30000);
      
      if (!addressesContainer) {
        showToast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤', 5000, '#a33');
        return;
      }

      // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∞–¥—Ä–µ—Å–∞
      // –ê–¥—Ä–µ—Å–∞ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ div._taskItem_36r29_38 –∏ –∏–º–µ—é—Ç span –≤–Ω—É—Ç—Ä–∏ _taskTitle_36r29_45
      await wait(1000); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤
      function getAddressesList() {
        const allAddressItems = document.querySelectorAll('div._taskItem_36r29_38');
        const addresses = [];
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–¥—Ä–µ—Å–∞: —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤ _taskTitle_36r29_45 –µ—Å—Ç—å span (—ç—Ç–æ –∞–¥—Ä–µ—Å–∞, –∞ –Ω–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã)
        allAddressItems.forEach(item => {
          const titleElement = item.querySelector('div._taskTitle_36r29_45');
          if (titleElement) {
            const span = titleElement.querySelector('span');
            // –ï—Å–ª–∏ –µ—Å—Ç—å span, —ç—Ç–æ –∞–¥—Ä–µ—Å (–Ω–µ –∫–≤–∞—Ä—Ç–∏—Ä–∞)
            if (span) {
              const addressTitle = span.textContent.trim();
              addresses.push({ element: item, title: addressTitle });
            }
          }
        });
        
        return addresses;
      }

      // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ —Å –∏—Ö —Ç–µ–∫—Å—Ç–∞–º–∏
      let addressesList = getAddressesList();

      if (addressesList.length === 0) {
        showToast('‚ùå –ê–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 5000, '#a33');
        return;
      }

      showToast(`üìã –ù–∞–π–¥–µ–Ω–æ –∞–¥—Ä–µ—Å–æ–≤: ${addressesList.length}`, 3000, '#555');

      totalCounters = 0;
      loadedCounters = 0;
      updateDisplay();

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –∞–¥—Ä–µ—Å
      for (let i = 0; i < addressesList.length; i++) {
        const addressInfo = addressesList[i];
        const addressTitle = addressInfo.title;
        
        showToast(`üìç –û–±—Ä–∞–±–æ—Ç–∫–∞ ${i + 1}/${addressesList.length}: ${addressTitle}`, 2000, '#555');
        
        // –ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É –∞–¥—Ä–µ—Å–æ–≤ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å–ø–∏—Å–æ–∫
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –∞–¥—Ä–µ—Å–∞ –ø–æ —Ç–µ–∫—Å—Ç—É
        const currentAddresses = getAddressesList();
        const currentAddress = currentAddresses.find(addr => addr.title === addressTitle);
        
        if (!currentAddress) {
          showToast(`‚ö†Ô∏è –ê–¥—Ä–µ—Å "${addressTitle}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ`, 3000, '#a33');
          continue;
        }
        
        // –ö–ª–∏–∫–∞–µ–º –Ω–∞ –∞–¥—Ä–µ—Å
        currentAddress.element.click();
        await wait(1500); // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä

        // –ñ–¥–µ–º –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä
        const apartmentsContainer = await waitForSelector('div._tasksContainer_36r29_11', 5000);
        if (!apartmentsContainer) {
          showToast(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—ã –¥–ª—è ${addressTitle}`, 3000, '#a33');
          continue;
        }

        // –°—á–∏—Ç–∞–µ–º –≤—Å–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã (–≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã _taskItem_36r29_38, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —Å–æ–¥–µ—Ä–∂–∞—Ç span –≤ _taskTitle_36r29_45)
        await wait(500); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
        const allItems = document.querySelectorAll('div._taskItem_36r29_38');
        let apartmentCount = 0;
        let loadedCount = 0;

        allItems.forEach(item => {
          const titleElement = item.querySelector('div._taskTitle_36r29_45');
          if (titleElement) {
            const span = titleElement.querySelector('span');
            // –ï—Å–ª–∏ –Ω–µ—Ç span, —ç—Ç–æ –∫–≤–∞—Ä—Ç–∏—Ä–∞ (–Ω–µ –∞–¥—Ä–µ—Å)
            if (!span) {
              apartmentCount++;
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ —Å—á–µ—Ç—á–∏–∫ (–∑–µ–ª–µ–Ω—ã–π –∑–Ω–∞—á–æ–∫)
              const statusElement = item.querySelector('div._taskStatus_36r29_56 svg');
              if (statusElement) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ç—Ä–∏–±—É—Ç color
                const colorAttr = statusElement.getAttribute('color');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º inline —Å—Ç–∏–ª—å
                const styleColor = statusElement.style.color || '';
                // –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç: #95CAB4 –∏–ª–∏ rgb(149, 202, 180)
                if (colorAttr === '#95CAB4' || 
                    colorAttr === 'rgb(149, 202, 180)' || 
                    styleColor === '#95CAB4' || 
                    styleColor === 'rgb(149, 202, 180)' ||
                    styleColor.includes('149, 202, 180')) {
                  loadedCount++;
                }
              }
            }
          }
        });

        totalCounters += apartmentCount;
        loadedCounters += loadedCount;
        updateDisplay();

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∞–¥—Ä–µ—Å–æ–≤
        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É "–Ω–∞–∑–∞–¥" —Å –∫–ª–∞—Å—Å–æ–º _leftControl_tcg9l_49
        const backButton = document.querySelector('div._leftControl_tcg9l_49');
        if (backButton) {
          backButton.click();
          await wait(1500); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤
        } else {
          // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±: –∏—â–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–¥–∞—á–∏" —Å –∫–ª–∞—Å—Å–æ–º _navItem_snyxi_40
          const tasksButton = Array.from(document.querySelectorAll('div._navItem_snyxi_40'))
            .find(el => {
              const label = el.querySelector('label');
              return label && label.textContent.trim() === '–ó–∞–¥–∞—á–∏';
            });
          if (tasksButton) {
            tasksButton.click();
            await wait(1500); // –£–≤–µ–ª–∏—á–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤
          } else {
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–Ω–æ–ø–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
            showToast(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è ${addressTitle}`, 3000, '#a33');
            // –ü—Ä–æ–±—É–µ–º –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.href = 'https://meter.printecs.com/';
            await wait(2000);
            // –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–¥—Å—á–µ—Ç
            showToast('‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–¥—Å—á–µ—Ç–∞', 5000, '#a33');
            return;
          }
        }
        
        // –ñ–¥–µ–º, –ø–æ–∫–∞ —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
        await waitForSelector('div._tasksContainer_36r29_11', 5000);
        await wait(500); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ DOM
      }

      showToast(`‚úÖ –ü–æ–¥—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –í—Å–µ–≥–æ: ${totalCounters}, –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${loadedCounters}`, 7000, '#2a7');
      
    } catch (error) {
      showToast(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 5000, '#a33');
    }
  }

        // ===== –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è =====
        function showConfirmationModal() {
          const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000000;
      display: flex;
      justify-content: center;
      align-items: center;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      font-family: sans-serif;
      min-width: 300px;
      max-width: 500px;
    `;
    
    modalContent.innerHTML = `
      <h3 style="margin-top:0; margin-bottom:15px;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
      <p style="margin-bottom:20px; line-height:1.5;">
        –ü—Ä–æ—Ü–µ—Å—Å –ø–æ–¥—Å—á–µ—Ç–∞ –≤—Å–µ—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è. 
        –°–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∫–∞–∂–¥—ã–π –∞–¥—Ä–µ—Å –∏ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—ã.
      </p>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button id="cancelCountBtn" style="padding:8px 20px; background:#6c757d; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px;">
          –û—Ç–∫–∞–∑–∞—Ç—å—Å—è
        </button>
        <button id="confirmCountBtn" style="padding:8px 20px; background:#007acc; color:white; border:none; border-radius:5px; cursor:pointer; font-size:13px; font-weight:bold;">
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </button>
      </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);

    modalContent.querySelector('#cancelCountBtn').addEventListener('click', () => {
      modal.remove();
    });

    modalContent.querySelector('#confirmCountBtn').addEventListener('click', () => {
      modal.remove();
      countAllCounters();
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

        // ===== –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ =====
        countAllBtn.addEventListener('click', () => {
          showConfirmationModal();
        });
      }
    });
  });

})();

