// –ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±—â–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
(() => {
  'use strict';

  // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ =====
  const positionKey = 'unified_panel_position';
  let panel = null;
  let content = null;
  let collapsed = null;
  const sections = [];

  function initPanel() {
    if (panel) return;

    panel = document.createElement('div');
    panel.style.cssText = `
      position: fixed;
      top: 10px;
      right: 250px;
      background: rgba(255,255,255,0.95);
      color: #000;
      font-family: sans-serif;
      font-size: 13px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 999999;
      width: 280px;
      max-height: 90vh;
      overflow-y: auto;
      transition: all 0.3s ease;
    `;
    document.body.appendChild(panel);

    const savedPosition = JSON.parse(localStorage.getItem(positionKey) || '{}');
    if (savedPosition.left && savedPosition.top) {
      panel.style.left = savedPosition.left;
      panel.style.top = savedPosition.top;
      panel.style.right = '';
    } else {
      const rect = panel.getBoundingClientRect();
      panel.style.left = `${rect.left}px`;
      panel.style.right = '';
    }

    collapsed = document.createElement('div');
    collapsed.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      padding: 5px 0;
    `;
    collapsed.innerHTML = `
      <span class="drag-handle" style="cursor: move; margin-right: 5px; font-size: 14px;">‚Üî‚Üï</span>
      –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
      <span style="font-size:14px; cursor:pointer;">‚öôÔ∏è</span>
    `;
    panel.appendChild(collapsed);

    content = document.createElement('div');
    content.style.display = 'none';
    panel.appendChild(content);

    collapsed.querySelector('span:last-child').addEventListener('click', () => {
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
    });

    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    const dragHandle = collapsed.querySelector('.drag-handle');

    dragHandle.addEventListener('mousedown', (e) => {
      isDragging = true;
      const rect = panel.getBoundingClientRect();
      
      // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞ –ø–∞–Ω–µ–ª–∏
      dragOffsetX = e.clientX - rect.left;
      dragOffsetY = e.clientY - rect.top;
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
      e.preventDefault();
      e.stopPropagation();
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
      document.body.style.userSelect = 'none';
      document.body.style.cursor = 'move';
      panel.style.pointerEvents = 'none';
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
      document.addEventListener('mousemove', onMouseMove, true);
      document.addEventListener('mouseup', onMouseUp, true);
    });

    function onMouseMove(e) {
      if (!isDragging) return;
      e.preventDefault();
      e.stopPropagation();
      
      // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é –æ—Ç –∫—É—Ä—Å–æ—Ä–∞ - –∂–µ—Å—Ç–∫–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
      let newLeft = e.clientX - dragOffsetX;
      let newTop = e.clientY - dragOffsetY;
      
      // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–∞–Ω–µ–ª–∏
      const panelWidth = panel.offsetWidth;
      const panelHeight = panel.offsetHeight;
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –æ–∫–Ω–∞ - –ø–∞–Ω–µ–ª—å —É–ø–∏—Ä–∞–µ—Ç—Å—è –∫—Ä–∞—è–º–∏
      // –õ–µ–≤—ã–π –∫—Ä–∞–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0
      if (newLeft < 0) newLeft = 0;
      // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —à–∏—Ä–∏–Ω—ã –æ–∫–Ω–∞
      if (newLeft + panelWidth > window.innerWidth) newLeft = window.innerWidth - panelWidth;
      // –í–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0
      if (newTop < 0) newTop = 0;
      // –ù–∏–∂–Ω–∏–π –∫—Ä–∞–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç—ã –æ–∫–Ω–∞
      if (newTop + panelHeight > window.innerHeight) newTop = window.innerHeight - panelHeight;
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ transform - –∂–µ—Å—Ç–∫–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∏–Ω–µ—Ä—Ü–∏–∏
      panel.style.left = `${newLeft}px`;
      panel.style.top = `${newTop}px`;
      panel.style.right = 'auto';
      panel.style.margin = '0';
      panel.style.transform = 'none';
    }

    function onMouseUp(e) {
      if (!isDragging) return;
      isDragging = false;
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
      document.body.style.userSelect = '';
      document.body.style.cursor = '';
      panel.style.pointerEvents = '';
      
      document.removeEventListener('mousemove', onMouseMove, true);
      document.removeEventListener('mouseup', onMouseUp, true);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
      localStorage.setItem(positionKey, JSON.stringify({
        left: panel.style.left,
        top: panel.style.top
      }));
    }
  }

  function registerSection(id, title, htmlContent, callbacks) {
    initPanel();
    sections.push({ id, title, htmlContent, callbacks });
    renderSections();
  }

  function renderSections() {
    if (!content) return;

    let html = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span style="font-weight:bold;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤</span>
        <span id="toggleCollapseUnified" style="cursor:pointer; font-size:14px;">üôà</span>
      </div>
    `;

    sections.forEach((section, index) => {
      // –í—Å–µ —Å–µ–∫—Ü–∏–∏ —Å–≤–µ—Ä–Ω—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      html += `
        <div class="section-${section.id}" style="margin-bottom:${index < sections.length - 1 ? '10px' : '0'}; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">
          <div class="section-header-${section.id}" style="background: #f5f5f5; padding: 8px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center;" onclick="window.meterScriptsPanelManager.toggleSection('${section.id}')">
            <span>${section.title}</span>
            <span class="section-arrow-${section.id}">‚ñ∂</span>
          </div>
          <div class="section-content-${section.id}" style="padding: 10px; display: none;">
            ${section.htmlContent}
          </div>
        </div>
      `;
    });

    content.innerHTML = html;

    const toggleBtn = content.querySelector('#toggleCollapseUnified');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        content.style.display = 'none';
        collapsed.style.display = 'flex';
      });
    }

    // –í—ã–∑—ã–≤–∞–µ–º callbacks –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    sections.forEach(section => {
      if (section.callbacks && section.callbacks.onRender) {
        const sectionContainer = content.querySelector(`.section-content-${section.id}`);
        if (sectionContainer) {
          section.callbacks.onRender(sectionContainer);
        }
      }
    });
  }

  function toggleSection(id) {
    if (!content) return;
    const sectionContent = content.querySelector(`.section-content-${id}`);
    const arrow = content.querySelector(`.section-arrow-${id}`);
    if (sectionContent && arrow) {
      if (sectionContent.style.display === 'none') {
        sectionContent.style.display = 'block';
        arrow.textContent = '‚ñº';
      } else {
        sectionContent.style.display = 'none';
        arrow.textContent = '‚ñ∂';
      }
    }
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –≤ window
  window.meterScriptsPanelManager = {
    registerSection,
    toggleSection
  };

})();

