// –ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±—â–µ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
(() => {
  'use strict';

  // ===== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ =====
  const positionKey = 'unified_panel_position';
  let panel = null;
  let content = null;
  let collapsed = null;
  const sections = [];

  function initPanel() {
    if (panel) return;

    panel = document.createElement('div');
    panel.style.cssText = `
      position: fixed;
      top: 10px;
      right: 250px;
      background: rgba(255,255,255,0.95);
      color: #000;
      font-family: sans-serif;
      font-size: 13px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 999999;
      width: 280px;
      max-height: 90vh;
      overflow-y: auto;
      transition: all 0.3s ease;
    `;
    document.body.appendChild(panel);

    const savedPosition = JSON.parse(localStorage.getItem(positionKey) || '{}');
    if (savedPosition.left && savedPosition.top) {
      panel.style.left = savedPosition.left;
      panel.style.top = savedPosition.top;
      panel.style.right = '';
    } else {
      const rect = panel.getBoundingClientRect();
      panel.style.left = `${rect.left}px`;
      panel.style.right = '';
    }

    collapsed = document.createElement('div');
    collapsed.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      padding: 5px 0;
    `;
    collapsed.innerHTML = `
      <span class="drag-handle" style="cursor: move; margin-right: 5px; font-size: 14px;">‚Üî‚Üï</span>
      –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
      <span style="font-size:14px; cursor:pointer;">‚öôÔ∏è</span>
    `;
    panel.appendChild(collapsed);

    content = document.createElement('div');
    content.style.display = 'none';
    panel.appendChild(content);

    collapsed.querySelector('span:last-child').addEventListener('click', () => {
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
    });

    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    const dragHandle = collapsed.querySelector('.drag-handle');

    dragHandle.addEventListener('mousedown', (e) => {
      isDragging = true;
      const rect = panel.getBoundingClientRect();
      
      // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ª–µ–≤–æ–≥–æ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É–≥–ª–∞ –ø–∞–Ω–µ–ª–∏
      dragOffsetX = e.clientX - rect.left;
      dragOffsetY = e.clientY - rect.top;
      
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
      e.preventDefault();
      e.stopPropagation();
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
      document.body.style.userSelect = 'none';
      document.body.style.cursor = 'move';
      panel.style.pointerEvents = 'none';
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
      document.addEventListener('mousemove', onMouseMove, true);
      document.addEventListener('mouseup', onMouseUp, true);
    });

    function onMouseMove(e) {
      if (!isDragging) return;
      e.preventDefault();
      e.stopPropagation();
      
      // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é –æ—Ç –∫—É—Ä—Å–æ—Ä–∞ - –∂–µ—Å—Ç–∫–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
      let newLeft = e.clientX - dragOffsetX;
      let newTop = e.clientY - dragOffsetY;
      
      // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –ø–∞–Ω–µ–ª–∏
      const panelWidth = panel.offsetWidth;
      const panelHeight = panel.offsetHeight;
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –æ–∫–Ω–∞ - –ø–∞–Ω–µ–ª—å —É–ø–∏—Ä–∞–µ—Ç—Å—è –∫—Ä–∞—è–º–∏
      // –õ–µ–≤—ã–π –∫—Ä–∞–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0
      if (newLeft < 0) newLeft = 0;
      // –ü—Ä–∞–≤—ã–π –∫—Ä–∞–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ —à–∏—Ä–∏–Ω—ã –æ–∫–Ω–∞
      if (newLeft + panelWidth > window.innerWidth) newLeft = window.innerWidth - panelWidth;
      // –í–µ—Ä—Ö–Ω–∏–π –∫—Ä–∞–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 0
      if (newTop < 0) newTop = 0;
      // –ù–∏–∂–Ω–∏–π –∫—Ä–∞–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç—ã –æ–∫–Ω–∞
      if (newTop + panelHeight > window.innerHeight) newTop = window.innerHeight - panelHeight;
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ transform - –∂–µ—Å—Ç–∫–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∏–Ω–µ—Ä—Ü–∏–∏
      panel.style.left = `${newLeft}px`;
      panel.style.top = `${newTop}px`;
      panel.style.right = 'auto';
      panel.style.margin = '0';
      panel.style.transform = 'none';
    }

    function onMouseUp(e) {
      if (!isDragging) return;
      isDragging = false;
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
      document.body.style.userSelect = '';
      document.body.style.cursor = '';
      panel.style.pointerEvents = '';
      
      document.removeEventListener('mousemove', onMouseMove, true);
      document.removeEventListener('mouseup', onMouseUp, true);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é
      localStorage.setItem(positionKey, JSON.stringify({
        left: panel.style.left,
        top: panel.style.top
      }));
    }
  }

  function registerSection(id, title, htmlContent, callbacks) {
    initPanel();
    sections.push({ id, title, htmlContent, callbacks });
    renderSections();
  }

  function renderSections() {
    if (!content) return;

    let html = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span style="font-weight:bold;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤</span>
        <span id="toggleCollapseUnified" style="cursor:pointer; font-size:14px;">üôà</span>
      </div>
    `;

    sections.forEach((section, index) => {
      // –í—Å–µ —Å–µ–∫—Ü–∏–∏ —Å–≤–µ—Ä–Ω—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      html += `
        <div class="section-${section.id}" style="margin-bottom:${index < sections.length - 1 ? '10px' : '0'}; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">
          <div class="section-header-${section.id}" style="background: #f5f5f5; padding: 8px; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; align-items: center;" onclick="window.meterScriptsPanelManager.toggleSection('${section.id}')">
            <span>${section.title}</span>
            <span class="section-arrow-${section.id}">‚ñ∂</span>
          </div>
          <div class="section-content-${section.id}" style="padding: 10px; display: none;">
            ${section.htmlContent}
          </div>
        </div>
      `;
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤–Ω–∏–∑—É
    html += `
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
          <span style="font-size: 11px; color: #666;">–í–µ—Ä—Å–∏—è: ${CURRENT_VERSION}</span>
          <button id="check-updates-btn" style="
            padding: 6px 12px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: background 0.2s ease;
          ">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</button>
        </div>
        <div id="update-status" style="font-size: 10px; color: #666; min-height: 14px;"></div>
      </div>
    `;

    content.innerHTML = html;

    const toggleBtn = content.querySelector('#toggleCollapseUnified');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        content.style.display = 'none';
        collapsed.style.display = 'flex';
      });
    }

    // –í—ã–∑—ã–≤–∞–µ–º callbacks –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    sections.forEach(section => {
      if (section.callbacks && section.callbacks.onRender) {
        const sectionContainer = content.querySelector(`.section-content-${section.id}`);
        if (sectionContainer) {
          section.callbacks.onRender(sectionContainer);
        }
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    const checkUpdatesBtn = content.querySelector('#check-updates-btn');
    const updateStatus = content.querySelector('#update-status');
    if (checkUpdatesBtn) {
      // –°—Ç–∏–ª–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
      checkUpdatesBtn.addEventListener('mouseenter', () => {
        if (!checkUpdatesBtn.disabled) {
          checkUpdatesBtn.style.background = '#005a9e';
        }
      });
      
      checkUpdatesBtn.addEventListener('mouseleave', () => {
        if (!checkUpdatesBtn.disabled) {
          checkUpdatesBtn.style.background = '#007acc';
        }
      });

      checkUpdatesBtn.addEventListener('click', async () => {
        checkUpdatesBtn.disabled = true;
        checkUpdatesBtn.style.background = '#999';
        checkUpdatesBtn.style.cursor = 'not-allowed';
        checkUpdatesBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        updateStatus.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...';
        
        try {
          const result = await checkVersionManual();
          if (result) {
            if (result.needsUpdate) {
              updateStatus.innerHTML = `<span style="color: #f59e0b;">üîî –î–æ—Å—Ç—É–ø–Ω–∞ –≤–µ—Ä—Å–∏—è v${result.latestVersion}</span>`;
              showUpdateNotification(result.latestVersion, result.downloadUrl, result.releaseUrl);
            } else {
              updateStatus.innerHTML = `<span style="color: #10b981;">‚úÖ –£ –≤–∞—Å –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (v${result.latestVersion})</span>`;
            }
          } else {
            updateStatus.innerHTML = `<span style="color: #ef4444;">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ</span>`;
          }
        } catch (error) {
          updateStatus.innerHTML = `<span style="color: #ef4444;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`;
        } finally {
          checkUpdatesBtn.disabled = false;
          checkUpdatesBtn.style.background = '#007acc';
          checkUpdatesBtn.style.cursor = 'pointer';
          checkUpdatesBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
        }
      });
    }
  }

  function toggleSection(id) {
    if (!content) return;
    const sectionContent = content.querySelector(`.section-content-${id}`);
    const arrow = content.querySelector(`.section-arrow-${id}`);
    if (sectionContent && arrow) {
      if (sectionContent.style.display === 'none') {
        sectionContent.style.display = 'block';
        arrow.textContent = '‚ñº';
      } else {
        sectionContent.style.display = 'none';
        arrow.textContent = '‚ñ∂';
      }
    }
  }

  // ===== –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ =====
  const CURRENT_VERSION = '0.10.2';
  const VERSION_CHECK_KEY = 'meter_scripts_version_check';
  const VERSION_STORAGE_KEY = 'meter_scripts_version';
  const GITHUB_REPO = 'JeanP00l/meterScripts';
  const CACHE_DURATION = 60 * 60 * 1000; // 1 —á–∞—Å –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
  const EXTENSION_ID = 'nbhcbdghjpllgmfilhnhkllmkecfmpld';

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
  const storedVersion = localStorage.getItem(VERSION_STORAGE_KEY);
  if (!storedVersion || storedVersion !== CURRENT_VERSION) {
    localStorage.setItem(VERSION_STORAGE_KEY, CURRENT_VERSION);
  }

  // –§—É–Ω–∫—Ü–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π (—Ñ–æ—Ä–º–∞—Ç: "0.10.2")
  function compareVersions(current, latest) {
    const currentParts = current.split('.').map(Number);
    const latestParts = latest.split('.').map(Number);
    
    for (let i = 0; i < Math.max(currentParts.length, latestParts.length); i++) {
      const currentPart = currentParts[i] || 0;
      const latestPart = latestParts[i] || 0;
      
      if (latestPart > currentPart) return -1; // –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      if (latestPart < currentPart) return 1;  // –¢–µ–∫—É—â–∞—è –Ω–æ–≤–µ–µ (–Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)
    }
    
    return 0; // –í–µ—Ä—Å–∏–∏ —Ä–∞–≤–Ω—ã
  }

  // –§—É–Ω–∫—Ü–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–µ—Ä—Å–∏–∏ (—É–±–∏—Ä–∞–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å "v" –µ—Å–ª–∏ –µ—Å—Ç—å)
  function normalizeVersion(tagName) {
    return tagName.replace(/^v/i, '');
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è)
  async function checkVersion() {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
      const cached = localStorage.getItem(VERSION_CHECK_KEY);
      if (cached) {
        const cacheData = JSON.parse(cached);
        const now = Date.now();
        
        // –ï—Å–ª–∏ –∫–µ—à –µ—â–µ –∞–∫—Ç—É–∞–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if (cacheData.timestamp && (now - cacheData.timestamp) < CACHE_DURATION) {
          if (cacheData.needsUpdate) {
            showUpdateNotification(cacheData.latestVersion, cacheData.downloadUrl, cacheData.releaseUrl || cacheData.downloadUrl);
          }
          return null;
        }
      }

      return await checkVersionManual();
    } catch (error) {
      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
      return null;
    }
  }

  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ (–¥–ª—è –∫–Ω–æ–ø–∫–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–µ—à)
  async function checkVersionManual() {
    try {
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑ —Å GitHub
      let response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/releases/latest`);
      
      // –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞ –Ω–µ—Ç (404), –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–µ–ª–∏–∑–æ–≤ –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
      if (!response.ok && response.status === 404) {
        response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/releases`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const releases = await response.json();
        if (!releases || releases.length === 0) {
          throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ–ª–∏–∑–æ–≤');
        }
        // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑ –∏–∑ —Å–ø–∏—Å–∫–∞ (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π)
        const release = releases[0];
        const latestVersion = normalizeVersion(release.tag_name);
        
        return processReleaseData(release, latestVersion);
      }
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const release = await response.json();
      const latestVersion = normalizeVersion(release.tag_name);
      
      return processReleaseData(release, latestVersion);
    } catch (error) {
      console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π:', error);
      throw error;
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–ª–∏–∑–∞
  function processReleaseData(release, latestVersion) {
    // –ò—â–µ–º JSON —Ñ–∞–π–ª –≤ assets
    let jsonUrl = null;
    if (release.assets && release.assets.length > 0) {
      // –ò—â–µ–º —Ñ–∞–π–ª, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π "json" –∏ "—Å–∫—Ä–∏–ø—Ç" –∏–ª–∏ "script"
      const jsonAsset = release.assets.find(asset => 
        asset.name.toLowerCase().includes('.json') && 
        (asset.name.toLowerCase().includes('—Å–∫—Ä–∏–ø—Ç') || 
         asset.name.toLowerCase().includes('script') ||
         asset.name.toLowerCase().includes('meter'))
      );
      if (jsonAsset) {
        jsonUrl = jsonAsset.browser_download_url;
      }
    }

    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ assets, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–ª–∏–∑–∞ –∫–∞–∫ fallback
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é
    if (!jsonUrl) {
      jsonUrl = release.html_url;
    }

    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏–∏
    const comparison = compareVersions(CURRENT_VERSION, latestVersion);
    const needsUpdate = comparison < 0;

    const releaseUrl = release.html_url;
    
    const result = {
      latestVersion,
      needsUpdate,
      downloadUrl: jsonUrl || releaseUrl,
      releaseUrl: releaseUrl
    };

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
    localStorage.setItem(VERSION_CHECK_KEY, JSON.stringify({
      timestamp: Date.now(),
      ...result
    }));

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    if (needsUpdate) {
      showUpdateNotification(latestVersion, jsonUrl || releaseUrl, releaseUrl);
    }

    return result;
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
  function showUpdateNotification(latestVersion, downloadUrl, releaseUrl) {
    // –ï—Å–ª–∏ releaseUrl –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º downloadUrl (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
    if (!releaseUrl) {
      releaseUrl = downloadUrl.includes('/releases/tag/') ? downloadUrl : `https://github.com/${GITHUB_REPO}/releases/latest`;
    }
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    const existing = document.getElementById('meter-scripts-update-notification');
    if (existing) {
      existing.remove();
    }

    const notification = document.createElement('div');
    notification.id = 'meter-scripts-update-notification';
    notification.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-family: sans-serif;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000000;
      max-width: 200px;
      cursor: pointer;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease, box-shadow 0.2s ease;
    `;

    notification.innerHTML = `
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 16px;">üîî</span>
        <div style="flex: 1;">
          <div style="font-weight: bold; margin-bottom: 4px;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ</div>
          <div style="font-size: 11px; opacity: 0.9;">v${latestVersion}</div>
        </div>
        <button id="update-download-btn" style="
          background: rgba(255,255,255,0.2);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          padding: 4px 8px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 11px;
          font-weight: bold;
        ">–°–∫–∞—á–∞—Ç—å</button>
      </div>
      <div id="update-close-btn" style="
        position: absolute;
        top: 4px;
        right: 4px;
        cursor: pointer;
        font-size: 14px;
        opacity: 0.8;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      ">√ó</div>
    `;

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    notification.addEventListener('mouseenter', () => {
      notification.style.transform = 'translateY(-2px)';
      notification.style.boxShadow = '0 6px 16px rgba(0,0,0,0.4)';
    });

    notification.addEventListener('mouseleave', () => {
      notification.style.transform = 'translateY(0)';
      notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
    const closeBtn = notification.querySelector('#update-close-btn');
    closeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      notification.style.opacity = '0';
      notification.style.transform = 'translateY(-10px)';
      setTimeout(() => notification.remove(), 300);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    const downloadBtn = notification.querySelector('#update-download-btn');
    downloadBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      
      try {
        // –í—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–ª–∏–∑–∞ –Ω–∞ GitHub
        window.open(releaseUrl, '_blank');
        
        // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ JSON —Ñ–∞–π–ª, —Å–∫–∞—á–∏–≤–∞–µ–º –µ–≥–æ
        if (downloadUrl.endsWith('.json') || downloadUrl.includes('/download/')) {
          // –°–∫–∞—á–∏–≤–∞–µ–º JSON —Ñ–∞–π–ª
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = `—Å–∫—Ä–∏–ø—Ç—ã-${latestVersion}.json`;
          link.target = '_blank';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–ª–∏–∑–∞
        window.open(releaseUrl, '_blank');
      }
    });

    document.body.appendChild(notification);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateY(0)';
    }, 10);
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  if (document.body) {
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(checkVersion, 2000);
  } else {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkVersion, 2000);
    });
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä –≤ window
  window.meterScriptsPanelManager = {
    registerSection,
    toggleSection
  };

})();

