# Product Requirements Document (PRD)
## Скрипты инструменталки для автоматизации учета показаний счетчиков

---

## 1. Общее описание проекта

### 1.1 Назначение
Набор пользовательских скриптов (userscripts) для автоматизации работы с веб-приложением по учету и проверке показаний счетчиков (meter.printecs.com). Скрипты предназначены для ускорения процесса заполнения форм, ввода данных и управления информацией о счетчиках.

### 1.2 Целевая аудитория
- Сотрудники, занимающиеся проверкой и учетом показаний счетчиков
- Пользователи веб-приложения meter.printecs.com
- Операторы, вводящие данные о счетчиках вручную

### 1.3 Основные задачи проекта
- Автоматизация рутинных операций при заполнении форм проверки счетчиков
- Ускорение процесса ввода данных через голосовой ввод
- Упрощение загрузки фотографий счетчиков
- Автоматизация перехода между записями и заполнения повторяющихся данных
- Предоставление инструментов для подсчета и анализа результатов

---

## 2. Технологический стек

### 2.1 Основные технологии
- **JavaScript (ES6+)** - основной язык разработки
- **Web Speech API** - для распознавания речи (webkitSpeechRecognition)
- **DOM API** - для взаимодействия с элементами страницы
- **LocalStorage API** - для сохранения настроек пользователя
- **MutationObserver API** - для отслеживания изменений DOM
- **File System Access API** - для выбора директории с фотографиями (`showDirectoryPicker`)
- **IndexedDB API** - для сохранения доступа к директории между сессиями
- **EXIF библиотека (exifr)** - для чтения метаданных фотографий (динамическая загрузка)
- **Fetch API** - для работы с локальным сервером синхронизации фото (создание сессии, опрос статуса, получение индекса после синхронизации). При автозагрузке фото запросы к серверу не выполняются
- **QR-код библиотека (qrcodejs)** - для генерации QR-кодов в браузере (динамическая загрузка)

### 2.2 Платформа
- **Браузерные расширения/Userscripts** - скрипты работают как пользовательские скрипты
- **Целевой браузер**: Google Chrome (рекомендуется для Web Speech API)
- **Целевой сайт**: meter.printecs.com

### 2.3 Зависимости
- Нет внешних зависимостей (чистый JavaScript)
- Используются только нативные браузерные API

### 2.4 Особенности работы с React
Целевое приложение meter.printecs.com построено на React, что требует специального подхода при работе с DOM-элементами. Подробное описание работы с React-приложением см. в документе [React-Integration.md](./React-Integration.md).

**Ключевые моменты**:
- Использование специальных функций для работы с React-полями:
  - `setReactInputValue()` - для обычных input/textarea полей
  - `setReactCheckboxValue()` - для checkbox полей
  - `setDateValue()` - для полей типа `input[type="date"]` (использует `valueAsDate`)
- Работа с React `_valueTracker` для корректного отслеживания изменений
- Правильная диспатча событий (`input`, `change`, `blur`) с `bubbles: true`
- Retry-логика для асинхронных обновлений состояния React
- Использование `MutationObserver` для отслеживания динамически создаваемых элементов
- Поиск полей по label для надежности (особенно важно для date полей)

---

## 3. Архитектура проекта

### 3.1 Структура модулей

#### 3.1.1 Менеджер общей панели настроек
**Файл**: `Менеджер общей панели настроек.txt`
- **Назначение**: Централизованная панель управления всеми скриптами
- **Функции**:
  - Регистрация секций настроек для каждого скрипта
  - Управление отображением панели (сворачивание/разворачивание)
  - Перетаскивание панели по экрану
  - Сохранение позиции панели в localStorage
  - Проверка обновлений через GitHub Releases API (выполняется при каждой загрузке страницы)
  - Уведомление о новых версиях
  - Кнопка ручной проверки обновлений

#### 3.1.2 Автозаполнение
**Файл**: `Автозаполнение.txt`
- **Назначение**: Автоматическое заполнение форм при проверке счетчиков
- **Основные функции**:
  - Автоматический переход между записями (следующая/предыдущая)
  - Автоматическое заполнение полей (год изготовления, год следующей поверки)
  - Автоматическая инкрементация номеров пломб
  - Управление шаблонами антимагнитных пломб
  - Блок быстрого выбора ДЮП/ГЕП с кнопкой "Просрочен"
  - Настраиваемые горячие клавиши

#### 3.1.3 Голосовой набор показаний
**Файл**: `Голосовой набор показаний.txt`
- **Назначение**: Ввод данных через распознавание речи
- **Основные функции**:
  - Распознавание показаний счетчиков (дневной/ночной тариф)
  - Распознавание типа счетчика (CE 101, CE 102M, Меркурий и др.)
  - Распознавание года выпуска ("выпуск 2015")
  - Распознавание номеров пломб ("пломба 85")
  - Поиск адресов по номеру квартиры ("адрес 38")
  - Настраиваемые горячие клавиши для активации

#### 3.1.4 Загрузка фото
**Файл**: `Загрузка фото.txt`
- **Назначение**: Упрощение процесса загрузки фотографий счетчиков
- **Основные функции**:
  - Глобальный drag-and-drop для загрузки изображений
  - Автоматическое определение контейнера для загрузки фото
  - Поддержка множественной загрузки изображений

#### 3.1.5 Автозагрузка фото в акты
**Файл**: `Автозагрузка фото в акты.txt`
- **Назначение**: Автоматическая загрузка фотографий счетчиков на основе номера ПУ из метаданных EXIF и синхронизация фото с Android приложением
- **Основные функции**:
  - Автоматическое определение номера счетчика из акта проверки
  - Поиск фотографий в указанной директории по номеру счетчика из EXIF метаданных (комментарии)
  - Автоматическая загрузка найденных фотографий в акт проверки
  - Проверка дубликатов для предотвращения повторной загрузки уже загруженных фото
  - Сохранение доступа к директории между сессиями через IndexedDB
  - Поддержка множественных фотографий для одного счетчика
  - Оптимизированная скорость обнаружения номера счетчика (кеширование, минимальные задержки)
  - **Синхронизация фото с Android**: Генерация QR-кода для подключения Android приложения к локальному серверу синхронизации
    - Создание сессии синхронизации на локальном сервере
    - Генерация минимизированного QR-кода с коротким токеном (12 символов hex вместо UUID)
    - Отображение QR-кода для сканирования Android приложением
    - Опрос статуса синхронизации в реальном времени
    - Автоматическое обновление индекса фото после завершения синхронизации
  - **Сохранение индекса фото**: Сохранение индекса фото в localStorage для работы без сервера
    - Индекс загружается с сервера после синхронизации
    - Индекс загружается из файла `.index/photo_index.json` при выборе директории
    - Автозагрузка фото работает без запросов к серверу
    - Приоритеты поиска фото: localStorage -> файл -> локальный кеш
    - Индекс сохраняется после перезагрузки страницы
  - **Модальное окно с инструкцией**: Отображение пошаговой инструкции при первом использовании синхронизации
    - Галочка "Больше не показывать" для сохранения предпочтений пользователя
    - Инструкция содержит 8 шагов по использованию синхронизации
    - Инструкция написана простым языком для пользователей без технических знаний
    - Ссылка на GitHub releases для скачивания последней версии сервера
    - Включен пункт про выбор директории с фото в настройках скриптов

#### 3.1.6 Подсчет результатов
**Файл**: `Подсчет результатов.txt`
- **Назначение**: Подсчет количества счетчиков и загруженных записей
- **Основные функции**:
  - Автоматический обход всех адресов и квартир
  - Подсчет общего количества счетчиков
  - Подсчет загруженных счетчиков (по статусу)
  - Сохранение результатов в localStorage

### 3.2 Взаимодействие модулей
- Все скрипты независимы и могут работать отдельно
- Менеджер общей панели настроек предоставляет единый интерфейс для регистрации секций настроек
- Скрипты используют общий механизм toast-уведомлений
- Настройки каждого скрипта сохраняются в localStorage с уникальными ключами

---

## 4. Функциональные требования

### 4.1 Автозаполнение

#### 4.1.1 Workflow автозаполнения
- При нажатии горячей клавиши (по умолчанию `/`):
  1. Проверка поля пломбы (`input#seal_number_terminal_cover`):
     - Если поле содержит значение (только цифры, без буквенной части), скрипт запоминает его и инкрементирует (+1)
     - Инкрементированное значение сохраняется в localStorage для следующей записи
     - Номера пломб теперь только цифры (ранее была буквенная часть, например "C4-00")
  2. Нажатие кнопки "Продолжить" (селектор: `button._button_alwez_1._wide_alwez_180[type="submit"]`)
  3. Автоматическая установка чекбокса (в зависимости от типа проверки):
     - `place === 1` → `input#owner_is_absent`
     - `place === 2` → `input#refusal_of_sign`
     - Если чекбокс уже установлен, повторное нажатие не выполняется
  4. Нажатие кнопки "Сохранить сверку" (селектор: `button._button_alwez_1._wide_alwez_180[type="submit"]`)
  5. Переход к следующей/предыдущей записи (настраивается):
     - Если `SledORPred === 1` (Следующий): кнопка "Следующее" (`button._button_alwez_1._icon_alwez_37._right_alwez_209[type="button"]`)
     - Если `SledORPred === 2` (Предыдущий): кнопка "Предыдущее" (`button._button_alwez_1._icon_alwez_37._left_alwez_43[type="button"]`)
  6. Автоматическое заполнение полей:
     - Номер пломбы (инкрементированное значение из предыдущей записи) в поле `input#seal_number_terminal_cover`
     - Примечание: заполнение года изготовления и года следующей поверки удалено из workflow

#### 4.1.2 Шаблон заполнения номера пломбы
- **Настройка шаблона:**
  - Поле для ввода шаблона номера пломбы находится в настройках скриптов в разделе "Автозаполнение"
  - Максимум 5 цифр
  - Валидация: только цифры (автоматическое удаление нецифровых символов)
  - Сохранение в localStorage с ключом `meter_script_settings` (поле `sealNumberTemplate`)
- **Автоматическое заполнение:**
  - При появлении поля `input#seal_number_terminal_cover` скрипт автоматически заполняет его шаблоном
  - Заполнение происходит только если:
     - Поле пустое
     - Шаблон задан (не пустой)
     - Не активен workflow автозаполнения (не установлен флаг `_workflowActive` и нет `workflow_next_seal` в localStorage)
  - Используется `MutationObserver` для отслеживания появления поля на странице
  - Заполнение выполняется в silent режиме (не триггерит другие обработчики)
- **Исключения:**
  - **Workflow автозаполнения:** Когда пользователь нажимает горячую клавишу автозаполнения, которая копирует номер пломбы из `input#seal_number_terminal_cover` и вставляет его увеличенное на +1 обратно в это же поле, скрипт не заполняет поле шаблоном
  - При активации workflow устанавливается флаг `_workflowActive`, который блокирует заполнение шаблоном
  - После завершения workflow флаг снимается
  - Если пользователь вручную изменил значение поля, шаблон не перезаписывает его
- **Отслеживание изменений:**
  - Watcher отслеживает изменения значения поля пользователем
  - При ручном изменении значения флаги сбрасываются, что позволяет заполнить шаблоном при следующем появлении пустого поля
  - Используется `MutationObserver` для отслеживания программных изменений значения

#### 4.1.3 Блок ДЮП/ГЕП
- Отображение блока с кнопками быстрого выбора года ДЮП/ГЕП под полем "Дата предыдущей поверки"
- Опции: "нет", "2022", "2023", "2024", "2025", "2026", "Просрочен"
- Работа с полем даты (`input[type="date"]`):
  - При выборе года (2022-2026) изменяется только год в дате, день и месяц сохраняются
  - Пример: если было "21.03.2015", при выборе "2025" становится "21.03.2025"
  - При выборе "нет" возвращается исходная дата
- Автоматическое обновление поля "Дата следующей поверки":
  - При любом изменении поля "Дата предыдущей поверки" автоматически обновляется поле "Дата следующей поверки"
  - Новая дата = дата предыдущей поверки + 16 лет, но на день раньше (день и месяц сохраняются, затем вычитается один день)
  - Пример: "21.03.2016" → "20.03.2032" (на день раньше)
  - Пример: "02.08.2017" → "01.08.2033" (на день раньше)
- При выборе "Просрочен":
  - Автоматическое изменение результата проверки на "Не соответствует" (используются новые селекторы: `._selectField_1ydb5_1`, `._container_8fpl2_1`, `._value_8fpl2_13`, `._panel_1q4rd_19`, `._option_8fpl2_78`)
  - Заполнение причины "Истек срок поверки" в поле `textarea#inaccordance_reason`
  - Снятие галки "Пломба на клемной крышке"
  - При переключении с "Просрочен" на другой пункт автоматически возвращается "Соответствует" и очищается причина

#### 4.1.4 Блок антимагнитной пломбы
- Отображение кнопок быстрого выбора шаблонов антимагнитной пломбы
- Управление шаблонами через модальное окно
- Автозаполнение через datalist

### 4.2 Голосовой набор показаний

#### 4.2.1 Распознавание показаний
- Активация по горячей клавише (по умолчанию F2)
- Распознавание числовых значений для:
  - Дневного тарифа (поле `current_value_1`)
  - Ночного тарифа (поле `current_value_2`)
- Поддержка распознавания русских числительных

#### 4.2.2 Распознавание типа счетчика
- Кодовое слово: "Счетчик"
- Поддерживаемые модели:
  - СЕ 101 S6 145 M6: "Счетчик эс6" или "Счетчик энергомера эс6" (СЕ - кириллица, M6 - латиница)
  - СЕ 101 R5 145 M6: "Счетчик эр5" или "Счетчик энергомера эр5" (СЕ - кириллица, M6 - латиница)
  - СЕ 101 R5.1 145 М6: "Счетчик эр5 точка 1" (СЕ - кириллица, М6 - кириллица)
  - CE 102M: "Счетчик ц е 102" или "Счетчик ц е 102м" (CE - латиница, M - латиница)
  - Меркурий 201.5,6,7,8, 200.02, 206 N, 206 RN: "Счетчик 201 точка 5"
- **Workflow изменения типа счетчика:**
  1. Поиск элемента с классом `._value_8fpl2_13`, содержащего текст "Соответствует"
  2. Клик на этот элемент для открытия панели выбора
  3. Ожидание появления панели `._panel_1q4rd_19` с опциями
  4. Поиск и клик на опцию "Не соответствует" (класс `._option_8fpl2_78`)
  5. Ожидание появления панели со списком типов счетчиков
  6. "Пропуск" панели со списком (клик над ней для закрытия)
  7. Ожидание появления поля `input#fact_counter_type` (класс `._input_gy901_8`)
  8. Заполнение поля фактического типа счетчика через `setReactInputValue`
- **Особенности:**
  - Для R5 показывается модальное окно выбора между "СЕ 101 R5 145 M6" и "СЕ 101 R5.1 145 М6"
  - Все типы счетчиков проверены на правильное использование кириллических и латинских символов
  - Используется retry-логика для ожидания появления элементов (до 30 попыток с задержкой 100мс)

#### 4.2.3 Распознавание года выпуска
- Кодовое слово: "Выпуск"
- Форматы: "выпуск 2015", "выпуск 15" → проверяет соответствие года и при необходимости заполняет поля
- Одна цифра интерпретируется как 200X год ("выпуск 7" → 2007)
- **Workflow обработки команды "Выпуск":**
  1. Поиск поля "Год изготовления ПУ -" через `._selectField_1ydb5_1` или `._selectField_1mapt_1`
  2. Извлечение текущего года из тега `<b>` внутри `<span>` с текстом "Год изготовления ПУ -"
  3. Сравнение текущего года с указанным пользователем годом
  4. **Если год соответствует:**
     - Отображается сообщение "✅ Год изготовления соответствует: [год]"
     - Поля дат не обновляются (год изготовления совпадает, не требуется изменение дат поверки)
  5. **Если год не соответствует:**
     - Поиск элемента с классом `._value_8fpl2_13`, содержащего текст "Соответствует"
     - Клик на этот элемент для открытия панели выбора
     - Ожидание появления панели `._panel_1q4rd_19` с опциями
     - Поиск и клик на опцию "Не соответствует" (класс `._option_8fpl2_78`)
     - Ожидание появления поля `input#fact_counter_manufacture_year`
     - Заполнение поля фактического года изготовления ПУ через `setReactInputValue`
     - Обновление полей дат:
       - **Дата предыдущей поверки** (`last_inspection_year`) - обновляется год, сохраняя день и месяц из текущей даты
       - **Дата следующей поверки** (`next_inspection_year`) - автоматически устанавливается на дату из `last_inspection_year` + 16 лет, но на день раньше
- **Особенности работы с полями даты:**
  - Используется специальная функция `setDateValue()` для работы с `input[type="date"]`
  - Функция использует `valueAsDate` как основной метод (лучше всего работает с React)
  - Автоматически обновляет отображаемый `span` с датой в формате "DD.MM.YYYY"
  - Поиск полей осуществляется по label ("Дата предыдущей поверки", "Дата следующей поверки") для надежности
  - Сохраняется день и месяц из текущей даты, меняется только год
  - Обновление полей происходит без прокрутки страницы (позиция прокрутки сохраняется)
- **Примеры работы:**
  - Пример 1: Пользователь говорит "Выпуск 15", в поле "Год изготовления ПУ -" стоит 2015:
    - Год соответствует, отображается сообщение "✅ Год изготовления соответствует: 2015"
    - Поля дат не изменяются
  - Пример 2: Пользователь говорит "Выпуск 15", в поле "Год изготовления ПУ -" стоит 2016:
    - Год не соответствует, скрипт:
      1. Изменяет селект на "Не соответствует"
      2. Заполняет `fact_counter_manufacture_year`: 2015
      3. Если текущая дата "08.05.2013", устанавливает:
         - `last_inspection_year`: "08.05.2015"
         - `next_inspection_year`: "07.05.2031" (2015 + 16 лет, но на день раньше)

#### 4.2.4 Распознавание номера пломбы
- Кодовое слово: "Пломба"
- Формат: "пломба [число]" → дополняет или заменяет конец текущего значения шаблона
- **Особенности:**
  - Поддержка распознавания русских числительных (например, "пломба шесть" вместо "пломба 6")
  - Однозначные числа автоматически дополняются нулем до двухзначного формата (например, "1" → "01", "0" → "00")
  - Поле `input#seal_number_terminal_cover` может содержать максимум 5 цифр
  - Если сумма цифр шаблона и произнесенного числа ≤ 5: дополняет в конец
  - Если сумма > 5: заменяет последние цифры шаблона, начиная с первой цифры нового числа
- **Примеры работы:**
  - Шаблон `054` + "пломба 37" → `05437` (дополнение)
  - Шаблон `054` + "пломба 144" → `05144` (замена последней цифры шаблона первой цифрой из 144)
  - Шаблон `054` + "пломба 1" → `05401` (дополнение с нулем)
  - Шаблон `054` + "пломба 15" → `05415` (дополнение)
  - Шаблон `054` + "пломба 1037" → `01037` (замена, так как сумма превышает 5)
  - Шаблон `054` + "пломба 0" → `05400` (дополнение с нулями)
- **Toast-уведомление:** Отображает полный номер пломбы после установки (например, "✅ Номер пломбы: 05437")

#### 4.2.5 Поиск адреса
- Кодовое слово: "Адрес"
- Формат: "адрес 38" → прокручивает до квартиры №38 и подсвечивает её
- Поддержка коммуналок (поиск по номеру комнаты)

#### 4.2.6 Распознавание разрядности
- Кодовое слово: "Разрядность"
- Форматы: "разрядность 7", "разрядность семь" → изменяет разрядность счетчика
- Поддержка распознавания русских числительных (ноль, один, два, три, четыре, пять, шесть, семь, восемь, девять)
- Диапазон допустимых значений: 4-9
- **Workflow изменения разрядности:**
  1. Поиск поля разрядности через `En[name="capacity_match"]` или по тексту "Разрядность -"
  2. Извлечение текущей разрядности из `<b>` тега внутри `<span>` с текстом "Разрядность - X"
  3. Проверка соответствия: если разрядность уже правильная, завершение работы
  4. Если разрядность не соответствует:
     - Поиск элемента с классом `._value_8fpl2_13`, содержащего текст "Соответствует"
     - Клик на этот элемент для открытия панели выбора
     - Ожидание появления панели `._panel_1q4rd_19` с опциями
     - Поиск и клик на опцию "Не соответствует" (класс `._option_8fpl2_78`)
     - Ожидание появления поля `input#fact_capacity`
     - Заполнение поля фактической разрядности через `setReactInputValue`
- **Особенности:**
  - Если уже установлено "Не соответствует", скрипт сразу заполняет поле `fact_capacity`
  - Поиск поля разрядности выполняется сначала через `name="capacity_match"`, затем по тексту "Разрядность -" в элементах с классом `._selectField_1ydb5_1` или `._selectField_1mapt_1`
  - Исключаются элементы, содержащие "Тип ПУ" или "Меркурий", чтобы не выбрать неправильное поле
  - Используется retry-логика для ожидания появления элементов (до 30 попыток с задержкой 100мс)
  - Извлечение разрядности приоритетно выполняется из `<b>` тега, затем из текста `span`, затем из всего текста элемента

### 4.3 Загрузка фото

#### 4.3.1 Drag-and-Drop
- Глобальная поддержка перетаскивания файлов на страницу
- Автоматическое определение контейнера для загрузки фото
- Фильтрация только изображений (image/*)
- Поддержка множественной загрузки

### 4.4 Автозагрузка фото в акты

#### 4.4.1 Настройка директории
- Выбор директории с фотографиями через File System Access API (`showDirectoryPicker`)
- Fallback на `webkitdirectory` для браузеров без поддержки File System Access API
- Подсчет количества фотографий в директории после выбора
- Отображение информации о выбранной директории и количестве фото в кеше
- Сохранение доступа к директории в IndexedDB для восстановления после перезагрузки страницы

#### 4.4.2 Поиск номера счетчика
- Автоматическое извлечение номера ПУ из акта проверки
- Поиск по селектору `._selectField_1ydb5_1` с текстом "№ ПУ"
- Извлечение номера из тега `<b>` внутри label
- Поддержка номеров счетчиков с буквами кириллицы и латиницы
- Кеширование результата поиска для ускорения повторных проверок
- Оптимизированный поиск через `querySelectorAll('label')` для повышения производительности

#### 4.4.3 Поиск фотографий по номеру счетчика
- Чтение EXIF метаданных из фотографий (комментарии)
- Использование библиотеки `exifr` с fallback на кастомный парсер EXIF
- Построение индекса фотографий для быстрого поиска (O(1) lookup)
- Нормализация номеров счетчиков для надежного сопоставления (нижний регистр, удаление спецсимволов)
- Поддержка частичного совпадения номеров счетчиков
- Обработка множественных фотографий для одного счетчика

#### 4.4.4 Проверка дубликатов
- Проверка файлов в `input.files` для определения уже загруженных фото
- Проверка элементов с `background-image` (фото отображаются через стили в `div._photoItem_vvuiq_52`)
- Определение data URL и blob URL в background-image для обнаружения уже загруженных фото
- Проверка изображений `<img>` в контейнере загрузки
- Проверка data-атрибутов элементов с превью фото
- Предотвращение повторной загрузки уже загруженных фото после перезагрузки страницы

#### 4.4.5 Загрузка фотографий
- Программная загрузка файлов через `DataTransfer` API
- Сохранение существующих файлов в `input.files` при добавлении новых
- Поддержка восстановления доступа к директории через IndexedDB
- Чтение файлов из восстановленного `FileSystemDirectoryHandle`
- Обработка ошибок с информативными toast-уведомлениями

#### 4.4.6 Синхронизация фото с Android приложением
- **Создание сессии синхронизации**: Запрос на создание сессии синхронизации на локальном сервере
  - Генерация короткого токена (12 символов hex вместо UUID) для уменьшения размера QR-кода
  - Получение IP адреса и порта сервера для подключения
  - Автоматическая проверка и замена `localhost` на реальный IP адрес в QR-коде
  
- **Генерация QR-кода**: Создание минимизированного QR-кода с оптимизированным форматом данных
  - Использование коротких ключей: `t` (token), `ip` (localIP), `p` (port) вместо полных названий
  - Удаление поля `url` (строится на клиенте из ip и port)
  - Уменьшение размера QR-кода на ~40-50% для лучшей читаемости при сканировании
  - Использование библиотеки `qrcodejs` для генерации QR-кода в браузере
  
- **Отображение инструкции**: Модальное окно с пошаговой инструкцией при первом использовании
  - Автоматическое отображение при нажатии на "Синхронизация фото"
  - Инструкция содержит 8 шагов: скачивание сервера, запуск, генерация QR-кода, сканирование на телефоне
  - Галочка "Больше не показывать" для сохранения предпочтений в localStorage
  - Ссылка на GitHub releases для скачивания последней версии сервера
  
- **Опрос статуса синхронизации**: Отслеживание прогресса синхронизации в реальном времени
  - Опрос статуса каждую секунду через API `/status?token=...`
  - Отображение прогресса: количество загруженных и пропущенных фото
  - Автоматическая остановка опроса при завершении или ошибке
  - Автоматическое обновление индекса фото после завершения синхронизации

#### 4.4.7 Сохранение и использование индекса фото
- **Загрузка индекса после синхронизации**: Автоматическое обновление индекса после завершения синхронизации
  - Запрос полного индекса через API `/index` (без параметров)
  - Сохранение индекса в localStorage под ключом `photo_sync_server_index`
  - Сохранение индекса в `window._savedServerIndex` для быстрого доступа
  
- **Загрузка индекса из файла**: Автоматическое чтение индекса при выборе директории
  - Поиск файла `.index/photo_index.json` в выбранной директории
  - Чтение файла через File System Access API
  - Сохранение индекса в localStorage и в `window._savedServerIndex`
  - Обработка случая, когда файл не найден (не критично)
  
- **Использование индекса при автозагрузке фото**: Автозагрузка работает без запросов к серверу
  - Приоритеты поиска фото (в порядке убывания):
    1. Сохраненный индекс из localStorage (ПРИОРИТЕТ 1)
    2. Чтение индекса из файла `.index/photo_index.json` в выбранной директории (ПРИОРИТЕТ 2)
    3. Локальный индекс из photosCache (построенный из EXIF метаданных) (ПРИОРИТЕТ 3)
  - Запросы к серверу при автозагрузке фото убраны для работы без запущенного сервера
  - Поддержка нормализации номеров счетчиков для надежного сопоставления
  - Поиск по точному совпадению, затем по обрезанным вариантам (если длина >= 3 символов)
  - Конвертация фото из индекса в формат для загрузки (сопоставление с файлами в кеше)
  
- **Восстановление индекса при загрузке страницы**: Сохранение индекса между сессиями
  - Автоматическая загрузка сохраненного индекса из localStorage при инициализации
  - Сохранение индекса в `window._savedServerIndex` для быстрого доступа
  - Попытка обновить индекс из файла при восстановлении доступа к директории

#### 4.4.8 Оптимизация производительности
- Кеширование номера счетчика для избежания повторного поиска
- Минимальные задержки в `MutationObserver` (100 мс вместо 2000 мс)
- Уменьшенная задержка перед проверкой дубликатов (300 мс вместо 1500 мс)
- Передача номера счетчика как параметра для избежания повторного поиска
- Индекс фотографий в памяти для быстрого поиска (O(1) вместо O(n))
- Оптимизированный поиск элементов через специфичные селекторы
- Работа автозагрузки без необходимости держать сервер открытым (использование сохраненного индекса)

### 4.4 Подсчет результатов

#### 4.4.1 Функция подсчета
- Автоматический переход на главную страницу
- Обход всех адресов в списке
- Для каждого адреса:
  - Открытие списка квартир
  - Подсчет общего количества квартир (счетчиков)
  - Подсчет загруженных счетчиков (по зеленому статусу)
  - Возврат к списку адресов
- Отображение результатов в панели настроек
- Сохранение результатов в localStorage

---

## 5. Нефункциональные требования

### 5.1 Производительность
- Скрипты должны работать без заметных задержек
- Использование MutationObserver для оптимизации отслеживания изменений DOM
- Минимальное использование ресурсов браузера

### 5.2 Совместимость
- Работа в Google Chrome (рекомендуется)
- Поддержка других браузеров на основе Chromium
- Совместимость с React-приложением (meter.printecs.com)

### 5.3 Надежность
- Обработка ошибок с отображением toast-уведомлений
- Проверка наличия элементов перед взаимодействием
- Retry-логика для установки значений в React-поля
- Специальные функции для работы с React-компонентами (см. [React-Integration.md](./React-Integration.md))

### 5.4 Удобство использования
- Настраиваемые горячие клавиши
- Визуальная обратная связь через toast-уведомления
- Перетаскиваемая панель настроек
- Сохранение позиции панели и настроек между сессиями

---

## 6. Интерфейс пользователя

### 6.1 Панель настроек
- **Расположение**: Фиксированная панель в правой части экрана (настраивается)
- **Функции**:
  - Сворачивание/разворачивание
  - Перетаскивание по экрану
  - Секции настроек для каждого скрипта
  - Сохранение позиции и состояния

### 6.2 Toast-уведомления
- **Расположение**: Правый нижний угол экрана
- **Типы**:
  - Успешные операции (зеленый)
  - Предупреждения (желтый/оранжевый)
  - Ошибки (красный)
  - Информационные (серый)

### 6.3 Блоки быстрого доступа
- Блок ДЮП/ГЕП с радио-кнопками
- Блок антимагнитной пломбы с кнопками шаблонов
- Автоматическое появление при загрузке соответствующих полей

---

## 7. Хранение данных

### 7.1 LocalStorage
Все настройки и данные хранятся в localStorage браузера:

- `meter_script_settings` - настройки автозаполнения (включая `place`, `hotkey`, `SledORPred`, `sealNumberTemplate`)
- `antimagnetic_templates` - шаблоны антимагнитных пломб
- `voice_fill_settings` - настройки голосового набора
- `voice_panel_position` - позиция панели голосового набора (legacy)
- `unified_panel_position` - позиция общей панели настроек
- `count_results` - результаты подсчета счетчиков
- `workflow_next_seal` - временное хранение номера пломбы для следующей записи
- `meter_scripts_version` - текущая версия установленных скриптов
- `meter_scripts_version_check` - результаты проверки обновлений (timestamp, latestVersion, needsUpdate, downloadUrl, releaseUrl) - используется для хранения информации, но не блокирует автоматическую проверку при загрузке страницы
- `autoPhotoUploadConfig` - настройки автозагрузки фото (включая `enabled`, `photosDirectory`)
- `autoPhotoUploadCache` - кеш фотографий с метаданными для быстрого поиска
- `photo_sync_server_index` - индекс фото с сервера синхронизации (JSON формат, аналогичен `photo_index.json`)
- `photoSync_instructions_shown` - флаг показа инструкции по синхронизации фото (`true` если пользователь выбрал "Больше не показывать")

---

## 8. Процесс релиза

### 8.1 Подготовка к релизу

Перед созданием нового релиза необходимо выполнить следующие шаги:

1. **Обновление версии в скрипте менеджера:**
   - Открыть файл `X-Y-Z/Менеджер общей панели настроек.txt` (где X-Y-Z - номер версии, например `0-10-3`, `0-12-1`, `1-1-5`)
   - Найти константу `CURRENT_VERSION` (обычно около строки 285)
   - Обновить значение на новую версию в формате `'X.Y.Z'` (например, `'0.10.4'`, `'0.12.1'`, `'1.1.5'`)
   - Сохранить файл

2. **Генерация JSON файла:**
   - После обновления версии в менеджере, **обязательно** попросить пользователя сгенерировать JSON файл
   - JSON файл должен содержать все актуальные скрипты из папки `X-Y-Z/` (где X-Y-Z - номер версии)
   - Файл должен быть назван в формате `Скрипты X-Y-Z.json` (где X-Y-Z - номер версии, например `Скрипты 0-10-3.json`, `Скрипты 0-12-1.json`)
   - Этот файл будет прикреплен к релизу на GitHub

3. **Копирование файлов в корень:**
   - Скопировать все обновленные файлы из папки `X-Y-Z/` в корень репозитория
   - Это необходимо для того, чтобы пользователи могли использовать актуальные версии скриптов

4. **Обновление документации:**
   - Обновить `README.md` с информацией о новой версии
   - Обновить `docs/PRD.md` с описанием изменений в разделе "История версий"

5. **Создание релиза:**
   - Использовать GitHub CLI для создания релиза: `gh release create vX.Y.Z` (где X.Y.Z - номер версии, например `v0.10.4`, `v0.12.1`, `v1.1.5`)
   - Прикрепить сгенерированный JSON файл к релизу
   - Добавить описание изменений в notes релиза

### 8.2 Важные замечания

- **Никогда не создавайте релиз без обновления версии в менеджере** - это приведет к неправильной работе проверки обновлений
- **Всегда ждите генерации JSON файла пользователем** - не создавайте релиз с устаревшим JSON файлом
- **Проверяйте актуальность всех файлов** перед копированием в корень репозитория

---

## 9. Версионирование

### 9.1 Текущая версия
**v0.10.4** - последняя стабильная версия

### 9.2 История версий
- **v0.10.4** (обновлено):
  - **Добавлен скрипт "Автозагрузка фото в акты":**
    - Автоматическое определение номера счетчика из акта проверки
    - Поиск фотографий в указанной директории по номеру счетчика из EXIF метаданных (комментарии)
    - Автоматическая загрузка найденных фотографий в акт проверки
    - Проверка дубликатов через анализ `input.files` и элементов с `background-image`
    - Сохранение доступа к директории через IndexedDB для восстановления после перезагрузки страницы
    - Поддержка File System Access API с fallback на `webkitdirectory`
    - Построение индекса фотографий для быстрого поиска (O(1) lookup)
    - Оптимизация скорости обнаружения номера счетчика (кеширование, уменьшенные задержки до ~400 мс)
    - Поддержка номеров счетчиков с буквами кириллицы и латиницы
    - Информативные toast-уведомления о статусе поиска и загрузки фото
  - **Синхронизация фото с Android приложением:**
    - Генерация QR-кода для подключения Android приложения к локальному серверу синхронизации
    - Создание сессии синхронизации на локальном сервере с коротким токеном (12 символов hex)
    - Минимизация QR-кода через использование коротких ключей и удаление избыточных данных
    - Опрос статуса синхронизации в реальном времени
    - Автоматическое обновление индекса фото после завершения синхронизации
    - Модальное окно с пошаговой инструкцией при первом использовании
  - **Сохранение индекса фото для работы без сервера:**
    - Сохранение индекса фото в localStorage после синхронизации
    - Автозагрузка фото работает без запросов к серверу
    - Приоритеты поиска: localStorage -> файл `.index/photo_index.json` -> локальный кеш
    - Загрузка индекса из файла `.index/photo_index.json` при выборе директории
    - Автозагрузка фото работает без запросов к серверу
    - Приоритеты поиска: localStorage -> файл `.index/photo_index.json` -> локальный кеш
    - Индекс сохраняется после перезагрузки страницы
  - **Оптимизация производительности:**
    - Кеширование результата поиска номера счетчика
    - Уменьшены задержки в `MutationObserver` (с 2000 мс до 100 мс)
    - Уменьшена задержка перед проверкой дубликатов (с 1500 мс до 300 мс)
    - Передача номера счетчика как параметра для избежания повторного поиска
    - Оптимизированный поиск элементов через специфичные селекторы

- **v0.10.3** (обновлено):
  - **Добавлен шаблон заполнения номера пломбы:**
    - Поле для ввода шаблона номера пломбы в настройках скриптов в разделе "Автозаполнение"
    - Максимум 5 цифр, валидация только цифры
    - Автоматическое заполнение поля `input#seal_number_terminal_cover` шаблоном при появлении пустого поля
    - Исключение для workflow автозаполнения: шаблон не заполняется, если активирован workflow (горячая клавиша)
    - Отслеживание изменений пользователем: если пользователь вручную изменил значение, шаблон не перезаписывает его
    - Используется `MutationObserver` для отслеживания появления поля на странице
    - Сохранение шаблона в localStorage (`meter_script_settings.sealNumberTemplate`)
  - **Улучшена функция обработки кодового слова "Пломба":**
    - Добавлена поддержка распознавания русских числительных (например, "пломба шесть" вместо "пломба 6")
    - Однозначные числа автоматически дополняются нулем до двухзначного формата (например, "1" → "01", "0" → "00")
    - Умная логика дополнения/замены: если сумма цифр шаблона и произнесенного числа ≤ 5, дополняет в конец; если > 5, заменяет последние цифры шаблона
    - Toast-уведомление теперь показывает полный номер пломбы после установки
    - Примеры: шаблон `054` + "пломба 37" → `05437`, шаблон `054` + "пломба 144" → `05144`
  - **Улучшена проверка обновлений:**
    - Проверка обновлений теперь выполняется при каждой перезагрузке страницы (без использования кеша)
    - Пользователь всегда видит актуальную информацию о доступных обновлениях
    - Убрана логика кеширования результатов проверки для автоматической проверки при загрузке

- **v0.10.2** (обновлено):
  - **Добавлена функция проверки обновлений:**
    - Автоматическая проверка новой версии при загрузке страницы
    - Уведомление о новой версии в правом верхнем углу страницы
    - Кнопка "Проверить обновления" в менеджере настроек
    - При обнаружении обновления: возможность скачать JSON файл и открыть страницу релиза на GitHub
    - Использует GitHub Releases API для получения информации о последней версии
    - Обработка случаев, когда последний релиз отсутствует (fallback на список релизов)

- **v0.10.1**:
  - **Исправлена ошибка исчисления поверок:**
    - Исправлена логика вычисления даты следующей поверки: теперь дата устанавливается на день раньше, чем дата предыдущей поверки + 16 лет
    - Пример: если дата предыдущей поверки "02.08.2017", то дата следующей поверки будет "01.08.2033" (а не "02.08.2033")
    - Изменения внесены в скрипты "Автозаполнение" и "Голосовой набор показаний"
    - Исправление применено к функции `updateNextInspectionDate()` и логике обработки команды "Выпуск"

- **v0.9.4** (обновлено):
  - **Обновлен workflow автозаполнения:**
    - Адаптация под новую структуру сайта (обновлены селекторы кнопок: `._button_alwez_1`, `._label_alwez_26`, `._wide_alwez_180`, `._icon_alwez_37`, `._right_alwez_209`, `._left_alwez_43`)
    - Номера пломб теперь только цифры (без буквенной части, ранее было "C4-00")
    - Упрощен workflow: удалено автоматическое заполнение года изготовления и года следующей поверки
    - Улучшена проверка чекбоксов: если чекбокс уже установлен, повторное нажатие не выполняется
    - Убрана прокрутка страницы при установке чекбоксов
    - Обновлена функция `incrementSeal()` для работы только с цифрами
    - Обновлена функция `findButtonByText()` для поддержки новых селекторов

- **v0.9.3** (обновлено): 
  - Исправлено распознавание "Выпуск" для одной цифры
  - **Улучшена функция "Выпуск":**
    - Добавлена проверка соответствия года в поле "Год изготовления ПУ -"
    - Если год соответствует указанному пользователем, поля дат не обновляются (год изготовления совпадает)
    - Если год не соответствует, автоматически изменяется селект на "Не соответствует" и заполняется поле фактического года изготовления
    - Используются селекторы `._selectField_1ydb5_1`, `._value_8fpl2_13`, `._panel_1q4rd_19`, `._option_8fpl2_78` для работы с React-компонентами
    - Извлечение года из тега `<b>` внутри поля "Год изготовления ПУ -" для проверки соответствия
  - Добавлено кодовое слово "пломба"
  - Добавлено кодовое слово "адрес"
  - Добавлено кодовое слово "разрядность" для изменения разрядности счетчика
  - Добавлен скрипт "Подсчет результатов"
  - Все настройки объединены в одно окно
  - Исправлено наложение сообщений отладки
  - **Улучшена работа с полями даты:**
    - Добавлена функция `setDateValue()` для работы с `input[type="date"]`
    - Использование `valueAsDate` как основной метод (лучше работает с React)
    - Автоматическое обновление отображаемого `span` с датой
    - Учет часового пояса (использование `T12:00:00` вместо `T00:00:00`)
    - Поиск полей по label ("Дата предыдущей поверки", "Дата следующей поверки") для надежности
    - Сохранение дня и месяца при обновлении года (команда "Выпуск 16")
    - **Добавлено автоматическое обновление поля "Дата следующей поверки":**
      - После обновления "Дата предыдущей поверки" автоматически устанавливается дата + 16 лет
      - Сохраняется день и месяц из даты предыдущей поверки
      - Обновление происходит без прокрутки страницы (позиция прокрутки сохраняется)
      - Оптимизирована скорость обновления (уменьшены задержки между операциями)
  - **Обновлен блок ДЮП/ГЕП:**
    - Блок теперь работает с полем даты (`input[type="date"]`) вместо поля года
    - При выборе года изменяется только год, день и месяц сохраняются
    - Добавлено автоматическое обновление поля "Дата следующей поверки" при изменении "Дата предыдущей поверки" (+16 лет)
    - Обновлены селекторы для работы с полем "Результат проверки" (новые классы: `._selectField_1ydb5_1`, `._container_8fpl2_1`, `._value_8fpl2_13`, `._panel_1q4rd_19`, `._option_8fpl2_78`)
    - Добавлена поддержка fallback на старые селекторы для обратной совместимости
    - Блок вставляется после контейнера поля даты

- **v0.9.0**:
  - Добавлены шаблоны антимагнитной пломбы
  - Добавлена кнопка "Просрочен" в блоке ДЮП/ГЕП
  - Добавлено распознавание типа ПУ
  - Добавлено заполнение года выпуска

---

## 10. Ограничения и известные проблемы

### 10.1 Ограничения
- Требуется браузер с поддержкой Web Speech API (Chrome рекомендуется)
- Зависимость от структуры DOM целевого сайта (при изменении структуры сайта скрипты могут перестать работать)
- Подсчет результатов не обновляется в реальном времени (требуется повторный запуск)

### 10.2 Известные проблемы
- Некоторые функции требуют перезагрузки страницы после изменения настроек

---

## 11. Будущие улучшения

### 11.1 Планируемые функции
- Экспорт результатов подсчета в файл
- Расширенная статистика по счетчикам
- Поддержка дополнительных типов счетчиков
- Улучшенная обработка ошибок с автоматическим восстановлением
- Поддержка темной темы для панели настроек
- Синхронизация настроек между устройствами

### 11.2 Технические улучшения
- Рефакторинг кода для лучшей модульности
- Добавление TypeScript для типобезопасности
- Создание системы плагинов для расширяемости
- Улучшение документации и примеров использования

---

## 12. Установка и использование

### 12.1 Установка
1. Установить менеджер пользовательских скриптов (например, Tampermonkey или Violentmonkey)
2. Установить скрипт "Менеджер общей панели настроек.txt" первым
3. Установить остальные скрипты в любом порядке
4. Открыть сайт meter.printecs.com

### 12.2 Настройка
- Все настройки доступны через панель "Настройки скриптов"
- Горячие клавиши настраиваются индивидуально для каждого скрипта
- Шаблоны антимагнитной пломбы управляются через модальное окно
- Шаблон номера пломбы настраивается в разделе "Автозаполнение" (максимум 5 цифр)

---

## 12. Контакты и поддержка

### 12.1 Структура проекта

**Структура репозитория GitHub:**
- В репозитории должны находиться только актуальные файлы скриптов и `README.md`
- Актуальные скрипты версии 0.10.4 находятся в корне репозитория:
  - `Менеджер общей панели настроек.txt`
  - `Автозаполнение.txt`
  - `Голосовой набор показаний.txt`
  - `Загрузка фото.txt`
  - `Автозагрузка фото в акты.txt`
  - `Подсчет результатов.txt`
  - `README.md`

**Локальная структура разработки:**
- Версии скриптов хранятся в папках `0-9-0/`, `0-9-3/`, `0-10-0/`, `0-10-1/`, `0-10-2/`, `0-10-3/`, `0-10-4/`
- Резервные копии в папке `backup/`
- Документация в папке `docs/` (не попадает в репозиторий)
- Тестовые файлы в папках `test/`, `test2/`, `test3/`

**Важно:**
- Папки с предыдущими версиями, документация и тестовые файлы не должны попадать в репозиторий GitHub
- При создании новой версии скрипты копируются из папки версии в корень репозитория
- JSON файлы для релизов находятся в папках версий и прикрепляются к релизам на GitHub

---

**Дата создания**: 2025-01-27  
**Версия PRD**: 1.0  
**Статус**: Актуальная версия

